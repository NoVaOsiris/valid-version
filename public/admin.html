<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ê–¥–º–∏–Ω–∫–∞</title>
    <style>
        body {
            font-family: sans-serif;
            padding: 20px;
        }

        h2, h3 {
            margin-top: 1.5em;
        }

        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 10px;
        }

        th, td {
            border: 1px solid #ccc;
            padding: 6px 10px;
            text-align: center;
        }

        th {
            background: #eee;
        }

        input[type="date"], button {
            margin: 4px;
        }
    </style>
</head>
<body>
    <h2>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, –∞–¥–º–∏–Ω!</h2>
    <div id="adminInfo"></div>

    <h3>üì¶ –°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤</h3>
   <div>
        <button id="refreshProducts">–û–±–Ω–æ–≤–∏—Ç—å</button>
        <input id="prodName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" />
        <input id="prodPrice" type="number" placeholder="–¶–µ–Ω–∞" />
        <button id="addProduct">–î–æ–±–∞–≤–∏—Ç—å</button>
    </div>
    <table>
     <thead><tr><th>ID</th><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–¶–µ–Ω–∞</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead>
        <tbody id="productsBody"></tbody>
    </table>

    <h3>üí∞ –ü—Ä–æ–¥–∞–∂–∏</h3>
    <label>–î–∞—Ç–∞: <input type="date" id="salesDate" /></label>
    <button id="loadSales">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
    <button id="exportSales">–°–∫–∞—á–∞—Ç—å Excel</button>
    <table>
        <thead><tr><th>–ü—Ä–æ–¥–∞–≤–µ—Ü</th><th>–¢–æ–≤–∞—Ä</th><th>–ö–æ–ª-–≤–æ</th><th>–¶–µ–Ω–∞</th><th>–°—É–º–º–∞</th><th>–í—Ä–µ–º—è</th></tr></thead>
        <tbody id="salesBody"></tbody>
    </table>
    <div id="salesTotal" style="margin-top: 10px; font-weight: bold;">–ò—Ç–æ–≥–æ: 0 ‚ÇΩ</div>

    <h3>üìä –û—Å—Ç–∞—Ç–∫–∏</h3>
    <label>–î–∞—Ç–∞: <input type="date" id="invDate" /></label>
    <button id="downloadInv">–°–∫–∞—á–∞—Ç—å Excel</button>

    <script>
        const admin = JSON.parse(localStorage.getItem('seller'));
        if (!admin || admin.role !== 'admin') {
            location.href = 'index.html';
        }
        document.getElementById('adminInfo').innerText = `–í—ã –≤–æ—à–ª–∏ –∫–∞–∫: ${admin.name}`;

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤
        async function loadProducts() {
            const res = await fetch('/api/products', { credentials: 'include' });
            const data = await res.json();
            const tbody = document.getElementById('productsBody');
            tbody.innerHTML = '';
            data.forEach(p => {
                const tr = document.createElement('tr');
              tr.innerHTML = `<td>${p.id}</td><td>${p.name}</td><td>${p.price}</td>
                    <td>
                        <button data-id="${p.id}" class="edit">‚úèÔ∏è</button>
                        <button data-id="${p.id}" class="del">üóëÔ∏è</button>
                    </td>`;
                tbody.appendChild(tr);
            });
            tbody.querySelectorAll('.edit').forEach(btn => {
                btn.onclick = () => editProduct(btn.dataset.id);
            });
            tbody.querySelectorAll('.del').forEach(btn => {
                btn.onclick = () => deleteProduct(btn.dataset.id);
            });
        }
        document.getElementById('refreshProducts').onclick = loadProducts;
         document.getElementById('addProduct').onclick = addProduct;

        async function addProduct() {
            const name = document.getElementById('prodName').value.trim();
            const price = +document.getElementById('prodPrice').value;
            if (!name || !price) return alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ —Ü–µ–Ω—É');
            await fetch('/api/products', {
                method: 'POST',
                credentials: 'include',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, price })
            });
            document.getElementById('prodName').value = '';
            document.getElementById('prodPrice').value = '';
            loadProducts();
        }

        async function editProduct(id) {
            const row = document.querySelector(`button.edit[data-id="${id}"]`).closest('tr');
            const currentName = row.children[1].innerText;
            const currentPrice = row.children[2].innerText;
            const name = prompt('–ù–∞–∑–≤–∞–Ω–∏–µ', currentName);
            if (name === null) return; // cancel
            const price = prompt('–¶–µ–Ω–∞', currentPrice);
            if (price === null) return;
            await fetch('/api/products', {
                method: 'POST',
                credentials: 'include',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id, name, price: +price })
            });
            loadProducts();
        }

        async function deleteProduct(id) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä?')) return;
            await fetch('/api/products/' + id, {
                method: 'DELETE',
                credentials: 'include'
            });
            loadProducts();
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–¥–∞–∂
        document.getElementById('loadSales').onclick = async () => {
            const date = document.getElementById('salesDate').value;
            if (!date) return alert('–£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É!');
            const res = await fetch('/api/sales?date=' + date, { credentials: 'include' });
            const data = await res.json();
            const tbody = document.getElementById('salesBody');
            tbody.innerHTML = '';
            let total = 0;
            data.forEach(r => {
                total += r.sum;
                const tr = document.createElement('tr');
                tr.innerHTML = `
              <td>${r.point}</td><td>${r.product}</td><td>${r.quantity}</td>
              <td>${r.price}</td><td>${r.sum}</td><td>${new Date(r.time).toLocaleString()}</td>
            `;
                tbody.appendChild(tr);
            });
            document.getElementById('salesTotal').innerText = `–ò—Ç–æ–≥–æ: ${total} ‚ÇΩ`;
        };

        // Excel-—ç–∫—Å–ø–æ—Ä—Ç –ø—Ä–æ–¥–∞–∂
        document.getElementById('exportSales').onclick = () => {
            const date = document.getElementById('salesDate').value;
            if (!date) return alert('–£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É!');
            window.location.href = '/api/sales-export.xlsx?date=' + date;
        };

        // Excel-—ç–∫—Å–ø–æ—Ä—Ç –æ—Å—Ç–∞—Ç–∫–æ–≤
        document.getElementById('downloadInv').onclick = () => {
            const date = document.getElementById('invDate').value;
            if (!date) return alert('–£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É!');
            window.location.href = '/api/inventory-all.xlsx?date=' + date;
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        window.addEventListener('load', () => {
            const today = new Date().toISOString().slice(0, 10);
            document.getElementById('salesDate').value = today;
            document.getElementById('invDate').value = today;
            loadProducts();
        });
    </script>
</body>
</html>
